<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css" type="text/css">
    <link rel="stylesheet" href="codemirror/theme/elegant.css" type="text/css">
    <style>
      .CodeMirror-scroll {
        height: auto;
        overflow-y: hidden;
        overflow-x: auto;
      }
      .CodeMirror-wrap {
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="navbar navbar-fixed-bottom">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Django Inspector</a>
          <ul class="nav">
            <li class="active"><a href="#">URLs</a></li>
            <li><a href="#">Apps</a></li>
            <li><a href="#">Models</a></li>
            <li><a href="#">Tags/Filters</a></li>
            <li><a href="#">Settings</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span6">
          <!--Sidebar content-->
          <ul class="nav nav-pills nav-stacked" id="urlpatterns"></ul>
        </div>
        <div class="span6">
          <!--Body content-->
          <div id="viewpanel">
            <h3 id="viewname"></h3>
            <code><a id="filename" href="#"></a></code>
          </div>
          <textarea cols="80" rows="10" id="viewcode"></textarea>
        </div>
      </div>
    </div>

    <script src="js/jquery-1.7.2.js" type="text/javascript"></script>
    <script src="js/underscore.js" type="text/javascript"></script>
    <script src="js/backbone.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.js" type="text/javascript"></script>
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/python/python.js"></script>
    <script type="text/javascript">
      window.App = {};
      _.extend(App, Backbone.Events);
      App.selectedPattern = null;

      App.editor = CodeMirror.fromTextArea(document.getElementById('viewcode'), {
        mode: "python",
        theme: "elegant",
        lineWrapping: true,
        lineNumbers: true,
        firstLineNumber: 12,
        readOnly: true
      });

      /* Router */

      var Workspace = Backbone.Router.extend({
        routes: {
          'urlpatterns': 'pattern_list',
          'urlpatterns/:pattern_id': 'pattern_detail'
        },
        pattern_list: function() {
          console.log('pattern_list');
        },
        pattern_detail: function (pattern_id) {
          console.log('pattern_detail: ' + pattern_id);
        }
      });


      /* Models */

      var URLPattern = Backbone.Model.extend({
        initialize: function() {
          //console.log('URLPattern created')
        }
      });
      var URLPatterns = Backbone.Collection.extend({
        model: URLPattern,
        url: 'js/test.json'
      });


      /* Views */

      var URLPatternRow = Backbone.View.extend({
        tagName: 'li',
        className: 'urlpattern',
        events: {
          'click': 'selectPattern'
        },
        render: function() {
          var ul = $(this.options.parent);
          $(this.el).html('<a href="#"><code>' + this.model.toJSON().pattern.regex + '</code></a>');
          ul.append(this.el);
          return this;
        },
        selectPattern: function() {
          $(this.el).toggleClass('active');
          App.selectedPattern = this.model;
          App.trigger('selectedPatternChanged', 'testing');
        }
      });

      var URLPatternListView = Backbone.View.extend({
        events: {
          'click li': 'selectPattern'
        },
        initialize: function() {
          var view = this;
          this.activeView = null;
          this._patternViews = [];
          _.bindAll(this, 'render');
          this.collection.bind('reset', this.render);
        },
        render: function() {
          var view = this;
          var ul = this.$el;
          this.$el.html('');
          this.collection.each(function(pattern) {
            var subView = new URLPatternRow({parent: ul, model: pattern});
            view._patternViews.push(subView);
            subView.render();
          });
          return this;
        },
        selectPattern: function(e) {
          $(this.activeElement).removeClass('active');
          this.activeElement = e.currentTarget;
        }
      });

      var ViewPanel = Backbone.View.extend({
        el: '#viewpanel',
        initialize: function() {
          var view = this;
          _.bindAll(this, 'render');
          App.bind('selectedPatternChanged', this.render);
        },
        render: function() {
          var pattern = App.selectedPattern.get('pattern');
          var view =  App.selectedPattern.get('view');
          this.$('#viewname').html(view.name);
          var lineNo = 12;
          this.$('#filename').attr('href', 'mvim://open?url=file://' + view.file + '&line=' + lineNo);
          this.$('#filename').text(view.file);
          App.editor.setValue(view.source);
        }
      });

      /* Setup */

      $(function () {
        var root = 'file:///Users/jkocherhans/Projects/urlviz/static/';
        var workspace = new Workspace;
        Backbone.history.start({pushState: true, root: root});
        //workspace.navigate('urlpatterns', {trigger: true, replace: false});

        var urlPatterns = new URLPatterns([]);

        var urlPatternListView = new URLPatternListView({
          collection: urlPatterns,
          el: $('#urlpatterns')
        });
        urlPatternListView.render();

        var viewPanel = new ViewPanel;

        urlPatterns.fetch();
      });

    </script>
  </body>
</html>

